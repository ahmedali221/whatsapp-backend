# ุญู ูุดููุฉ ุงูุชุนููู ุนูุฏ ุฑูุน ููู Excel - Performance Fix

## ๐ด ุงููุดููุฉ (The Problem)

### ุงููุตู:
ุนูุฏูุง ูุญุงูู ุฃูุซุฑ ูู ูุณุชุฎุฏู ุฑูุน ููู Excel ูู ููุณ ุงูููุชุ ุฃู ุนูุฏูุง ูุญุงูู ูุณุชุฎุฏู ูุงุญุฏ ุฑูุน ููู ูุจูุฑุ ูุญุฏุซ ุงูุชุงูู:

1. **ุงูุชุนููู ุนูุฏ ุฑูุน Excel**: ุงูุนูููุฉ ุชุชููู ูุชุนูู
2. **Request Timeout**: ุจุนุฏ ุงูุชุนูููุ ุฃู ุตูุญุฉ ุฃุฎุฑู ุชุนูู ุฃูุถุงู
3. **ุชุนุทู ุงููููุน ุจุงููุงูู**: ุงููููุน ููู ูุชููู ุนู ุงูุนูู

### ุงูุณุจุจ ุงูุฌุฐุฑู (Root Cause):

#### 1. **N+1 Query Problem** (ุงููุดููุฉ ุงูุฃุณุงุณูุฉ)
```typescript
// ุงูููุฏ ุงููุฏูู - ูุงู ูุนูู query ููู ุตู ุนูู ุญุฏุฉ
for (let i = 0; i < data.length; i++) {
  const existingContact = await this.contactRepo.findOne({
    where: { userId, phone },
  });
  // ูู ุงูููู ููู 1000 ุตู = 1000 query ูููุตูุฉ!
}
```

**ุงููุดููุฉ:**
- ูู ุงูููู ููู 1000 ุตู = 1000 ุงุณุชุนูุงู ูุงุนุฏุฉ ุจูุงูุงุช ูููุตู
- ูู ุงุณุชุนูุงู ูุฃุฎุฐ ููุช (ูุซูุงู 50ms) = 50 ุซุงููุฉ ูุงููุฉ!
- ุนูุฏ ุงูุงุณุชุฎุฏุงู ุงููุชุฒุงููุ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุชุนุทู

#### 2. **Connection Pool Exhaustion**
- ูู ูุณุชุฎุฏู ุจูุณุชููู ุงุชุตุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูู 3 ูุณุชุฎุฏููู ุฑูุนูุง ูููุงุช ูู ููุณ ุงูููุช = 3000 query ูุชุฒุงููุฉ
- ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุด ูุงุฏุฑุฉ ุชุชุนุงูู ูุน ุงููู ุฏู
- ุงููุชูุฌุฉ: ูู ุงูุงุชุตุงูุงุช ุชุชุนุทู

#### 3. **No Timeout Protection**
- ูู ุงูุนูููุฉ ุนููุชุ ูุด ูู timeout ูููููุง
- ุงูุทูุจ ููุถู ูุนูู ููุด ุจูุฎูุต
- ุงููุชูุฌุฉ: ุงููููุน ููู ูุชุนุทู

---

## โ ุงูุญู (The Solution)

### 1. **Batch Processing - ูุนุงูุฌุฉ ุฏูุนุงุช**

#### ูุจู (Before):
```typescript
// 1000 query ูููุตูุฉ
for (let i = 0; i < data.length; i++) {
  const existingContact = await this.contactRepo.findOne({...});
}
```

#### ุจุนุฏ (After):
```typescript
// ุงุณุชุนูุงู ูุงุญุฏ ููุท ูุฌููุน ุงูุฃุฑูุงู
const existingContacts = await this.contactRepo.find({
  where: {
    userId,
    phone: In(normalizedPhones), // ูู ุงูุฃุฑูุงู ูุฑุฉ ูุงุญุฏุฉ
  },
});
```

**ุงููุชูุฌุฉ:**
- ุจุฏู 1000 query โ **1 query ููุท**
- ุงูููุช: ูู 50 ุซุงููุฉ โ **50ms**
- ุชุญุณูู ุงูุฃุฏุงุก: **1000x ุฃุณุฑุน!**

### 2. **Batch Insert - ุฅุฏุฑุงุฌ ุฏูุนุงุช**

#### ูุจู (Before):
```typescript
await this.contactRepo.save(contacts); // ูุญูุธ ูู ุดูุก ูุฑุฉ ูุงุญุฏุฉ
```

#### ุจุนุฏ (After):
```typescript
// ุญูุธ ูู ุฏูุนุงุช ูู 500 ุตู
const batchSize = 500;
for (let i = 0; i < contactsToSave.length; i += batchSize) {
  const batch = contactsToSave.slice(i, i + batchSize);
  await queryRunner.manager.save(Contact, batch);
}
```

**ุงูููุงุฆุฏ:**
- ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ
- ุชุญุณูู ุงูุฃุฏุงุก ูููููุงุช ุงููุจูุฑุฉ
- ุงุณุชุฎุฏุงู Transaction ููุถูุงู

### 3. **Connection Pool Configuration**

```typescript
extra: {
  max: 20,  // ุฃูุตู ุนุฏุฏ ุงุชุตุงูุงุช ูุชุฒุงููุฉ
  min: 5,   // ุฃูู ุนุฏุฏ ุงุชุตุงูุงุช (ุฏุงุฆูุงู ูุชุงุญุฉ)
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 10000,
}
```

**ุงูููุงุฆุฏ:**
- ุฏุนู ุงุณุชุฎุฏุงู ูุชุฒุงูู ูู ุนุฏุฉ ูุณุชุฎุฏููู
- ููุน ุงุณุชููุงุฏ ุงูุงุชุตุงูุงุช
- ุฅุฏุงุฑุฉ ุฃูุถู ููููุงุฑุฏ

### 4. **Timeout Protection**

```typescript
return Promise.race([
  this.contactsService.uploadExcel(...),
  new Promise((_, reject) =>
    setTimeout(() => reject(new BadRequestException('Timeout')), 120000)
  ),
]);
```

**ุงูููุงุฆุฏ:**
- ููุน ุงูุชุนููู ุงูุฏุงุฆู
- ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ูููุณุชุฎุฏู
- ุชุญุฑูุฑ ุงูููุงุฑุฏ ุจุนุฏ 2 ุฏูููุฉ

---

## ๐ ููุงุฑูุฉ ุงูุฃุฏุงุก (Performance Comparison)

| ุงููููุงุณ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |
|---------|-----|-----|---------|
| ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช (1000 ุตู) | 1000 query | 1 query | **1000x** |
| ุงูููุช ุงููุชููุน | ~50 ุซุงููุฉ | ~50ms | **1000x ุฃุณุฑุน** |
| ุงุณุชููุงู ุงูุงุชุตุงูุงุช | ุนุงูู ุฌุฏุงู | ููุฎูุถ | **ุชุญุณูู ูุจูุฑ** |
| ุฏุนู ุงููุณุชุฎุฏููู ุงููุชุฒุงูููู | 1-2 ูุณุชุฎุฏู | 10+ ูุณุชุฎุฏู | **5x ุฃูุซุฑ** |
| ุงุณุชููุงู ุงูุฐุงูุฑุฉ | ุนุงูู | ููุฎูุถ | **ุชุญุณูู** |

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ (Modified Files)

1. **`backend/src/contacts/contacts.service.ts`**
   - ุงุณุชุฎุฏุงู `In()` ููุงุณุชุนูุงู ุงูุฌูุงุนู
   - Batch insert ูู ุฏูุนุงุช
   - Transaction management

2. **`backend/src/config/database.config.ts`**
   - ุฅุถุงูุฉ Connection Pool settings
   - ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุงุชุตุงูุงุช

3. **`backend/src/contacts/contacts.controller.ts`**
   - ุฅุถุงูุฉ Timeout protection
   - ููุน ุงูุชุนููู ุงูุฏุงุฆู

---

## ๐ ููููุฉ ุงูุชุทุจูู (How to Apply)

```bash
# 1. Rebuild the backend
cd backend
npm run build

# 2. Restart the containers
docker compose down
docker compose up --build -d

# 3. Test the upload with a large file
```

---

## โจ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

- โ ุฑูุน ูููุงุช Excel ุจุณุฑุนุฉ ูุจูุฑุฉ (ุญุชู 1000+ ุตู)
- โ ุฏุนู ุงุณุชุฎุฏุงู ูุชุฒุงูู ูู ุนุฏุฉ ูุณุชุฎุฏููู
- โ ูุง ูุฒูุฏ ูู ุงูุชุนููู ุฃู Request Timeout
- โ ุงููููุน ูุนูู ุจุณูุงุณุฉ ุญุชู ูุน ุงูุงุณุชุฎุฏุงู ุงููุซูู

---

## ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

- ุงููููุงุช ุงูุฃูุจุฑ ูู 5000 ุตู ูุฏ ุชุญุชุงุฌ ููุช ุฃุทูู (ููู ูู ุชุนูู)
- Timeout ูุญุฏุฏ ุนูู 2 ุฏูููุฉ (ูููู ุชุนุฏููู ุญุณุจ ุงูุญุงุฌุฉ)
- Connection Pool ูููู ุฒูุงุฏุชู ุฅุฐุง ูุงู ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุชุฒุงูููู ูุจูุฑ





